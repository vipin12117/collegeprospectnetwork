<?php    include_once ("inc/common_functions.php");    //for common function    include_once ("inc/page.inc.php");    include_once 'Video-Flv-Video-Trimmer.php';    session_start();    if (($_SESSION['mode'] == "") or ($_SESSION['FRONTEND_USER'] == "") or $_SESSION['mode'] != "athlete") {        header("Location:login.php");    }    $func = new COMMONFUNC;    $db = new DB;    $flag = 0;    $msg = "";    $MaxMins = 10;    $MaxSeconds = 60;                            //max video size - local variable    define("MAX_SIZE", "200000");        //Increase PHP Execution Time - 600 = 60x10minutes    #ini_set('max_input_time', 600);      #ini_set('max_execution_time', 600);         //Increase PHP Execution Time - UNLIMITED    ini_set('max_input_time', 0);      ini_set('max_execution_time', 0);             //Get Video Extension    function getExtension($str) {        $i = strrpos($str, ".");        if (!$i) {            return "";        }        $l = strlen($str) - $i;        $ext = substr($str, $i + 1, $l);        return $ext;    }            $fldId = $_REQUEST['fldId'];            //Submit Form    if ($_POST['isSubmit'] == 'TrimVideo') {                $timeTrimStart = $func -> input_fun($_POST['trimStart']);        $timeTrimEnd = $func -> input_fun($_POST['trimEnd']);                                if (strlen($timeTrimStart) < 6 ) {            $timeTrimStart = "00:" . $timeTrimStart;         }        if (strlen($timeTrimEnd) < 6 ) {            $timeTrimEnd = "00:" . $timeTrimEnd;         }                        //Test Vars        // echo "Trim Start: " . $timeTrimStart;
        // echo " | Trim End: " . $timeTrimEnd;
        // echo " | VideoID: " . $fldId;                //echo "Video Trimming in Process, Please wait...";                ### TRIM VIDEO ###        //ffmpeg -i video.avi -vcodec copy -acodec copy -ss 00:00:00 -t 00:00:04 trimmed_video.avi                if ($flag == 0) {                         //Get Athlete Data            $query_Athlete = " Select * from " . TBL_ATHELETE_REGISTER . " where fldUsername ='" . $_SESSION['FRONTEND_USER'] . "'";            $db1 -> query($query_Athlete);            $db1 -> next_record();                        //Insert data            ///////////            $newname = "video/" . $video_name;            $flvobj = new flv();            $flvobj -> FFLV_PATH = '/usr/bin/';            $flvobj -> APP_ROOT = 'video/';            $flvobj -> output_file = 'video/';                        //Set TRIM Start & TRIM END time            $flvobj -> TRIM_START = $timeTrimStart;                      $flvobj -> TRIM_END = $timeTrimEnd;                    $flvobj -> newname = "cpn_" . $db1 -> f('fldId') . "-". time();  //append cpn_AthleteID- to filename                        $OriginalVideoFilename = $_REQUEST['hdnVideoFilename'];               $OriginalVideoTitle = $_REQUEST['hdnVideoTitle'];                   $videoType = "Highlight Video";            $videoStatus = "1";            $video = $flvobj -> convert_video($OriginalVideoFilename);            if ($video != '') {                  //Disable all other videos for this user                $where = "fldAthleteId=".$db1 -> f('fldId');                $strDataArr=array('fldStatus' => 0);                $db->updateRec(TBL_ATHLETE_VIDEO,$strDataArr, $where);                                  //Delete any other Highlight Videos                                $delete_query_details = "delete from " . TBL_ATHLETE_VIDEO . " where fldAthleteId='".$db1 -> f('fldId')."' AND fldVideoType='Highlight Video' ";                $delmsg = $db -> query($delete_query_details);                                                                    //Insert This New Trimmed Video for this user                                    $strDataArr = array('fldTitle' => $OriginalVideoTitle, 'fldVideo' => $video, 'fldAddDate' => date("y-m-d"), 'fldStatus' => $videoStatus, 'fldAthleteId' => $db1 -> f('fldId'), 'fldVideoType' => $videoType);                $VideoID = $db -> insertRec(TBL_ATHLETE_VIDEO, $strDataArr);                                          }                                              if (($VideoID) and ($video != '')) {                header("Location:Video-List.php?msg=Game Tape successfully trimmed.  This new Highlight Clip is set to Active");                //$_REQUEST['msg'] = "Game Tape successfully trimmed.  This new trimmed video is set to Active";            }            else            {                $_REQUEST['error_msg'] = "An Error Occured during Trimming Process, please re-try using a smaller Original Video. <a href='Video-List.php'>Return to Manage Game Tape</a>";            }                    }    }    //END if submit                 if ($_GET['mode'] == 'edit' AND $fldId != "") {                     $fldId = $_REQUEST['fldId'];            $VideoQuery =" Select * from ".TBL_ATHLETE_VIDEO." where fldAthleteId='" . $_SESSION['Athlete_id'] . "' and fldId='" . $fldId . "'    ";            $db->query($VideoQuery);            $db->next_record();                        $fldVideo = $func->output_fun($db->f('fldVideo'));              $fldTitle = $func->output_fun($db->f('fldTitle'));              $fldStatus = $func->output_fun($db->f('fldStatus'));                                                     $imagename = str_replace(".flv", ".jpg", $fldVideo);            $fldVideoType = $func->output_fun($db->f('fldVideoType'));                           $file= "video/" . $fldVideo;                    //ffmpeg-php method without the same output as mine:            //$movie = new ffmpeg_movie($file);            //echo $movie->getDuration();                        ob_start();            //$whereis ffmpeg: change with /usr/local/bin/ffmpeg            //exec( $this->FFLV_PATH."ffmpeg -i $this->APP_ROOT$newName -vframes 1 -ss 00:00:05 ".$this->output_file.$this->newname.".jpg");                          passthru("/usr/bin/ffmpeg -i ".$file." 2>&1");            $duration = ob_get_contents();            ob_end_clean();                        //the full output:            //echo $duration."<br/>";                        $search='/Duration: (.*?)[.]/';            $duration=preg_match($search, $duration, $matches, PREG_OFFSET_CAPTURE);            $duration = $matches[1][0];                        //i suppose that our video hasn't duration of a day+ :            list($hours, $mins, $secs) = split('[:]', $duration);                        $VideoDuration =  $hours." Hours, ".$mins." Minutes, ".$secs." Seconds";                                                            $timeFormat = "'mm:ss'";            $inputStart = "00:00";            $inputEnd = $mins . ":" . $secs;            $jsEndTime = "00:" . $mins . ":" . $secs;                        $showHour = "false";            $MaxHours = $hours;            $MaxMins = $mins;            $MaxSeconds = 59;                        if ($hours > 0) {                $timeFormat = "'hh:mm:ss'";                $inputStart = "00:00:00";                $inputEnd = $hours . ":" . $mins . ":" . $secs;                $jsEndTime = $hours . ":" . $mins . ":" . $secs;                $showHour = "true";                $MaxSeconds = 59;                $MaxMins = 59;            }            else if ($mins < 1) {
                $MaxSeconds = $secs;
                $MaxMins = 0;
            }                        //DEBUG LOCAL            //$MaxMins = 1;            //$MaxSeconds = 11;    }                                                                                       ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml">	<head>		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />		<title>College Prospect Network - Trim Game Tape</title>		<link href="css/style.css" rel="stylesheet" type="text/css" />		<link rel="stylesheet" media="all" type="text/css" href="css/start/jquery-ui-1.8.18.custom.css" />				<style type="text/css">             .wrapper{ background-color: #ffffff; width: 800px; border: solid 1px #eeeeee; padding: 20px; margin: 0 auto; }            .example-container{ background-color: #f4f4f4; border-bottom: solid 2px #777777; margin: 0 0 40px 0; padding: 20px; }            .example-container p{ font-weight: bold; }            .example-container > dl dt{ font-weight: bold; height: 20px; }            .example-container > dl dd{ margin: -20px 0 10px 100px; border-bottom: solid 1px #fff; }            .example-container input{ width: 150px; }            .clear{ clear: both; }                        #ui-datepicker-div, .ui-datepicker{ font-size: 80%; }                        /* css for timepicker */            .ui-timepicker-div .ui-widget-header { margin-bottom: 8px; }            .ui-timepicker-div dl { text-align: left; }            .ui-timepicker-div dl dt { height: 25px; margin-bottom: -25px; }            .ui-timepicker-div dl dd { margin: 0 10px 10px 65px; }            .ui-timepicker-div td { font-size: 90%; }            .ui-tpicker-grid-label { background: none; border: none; margin: 0; padding: 0; }                             .ui-datepicker .ui-datepicker-buttonpane button.ui-datepicker-current {            float:left;            background: #900;            display: none;            }                           </style>                 		<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>        <script type="text/javascript" src="js/jquery-ui-1.8.18.custom.min.js"></script>        <script type="text/javascript" src="js/jquery-ui-timepicker-addon.js"></script>        <script type="text/javascript" src="js/jquery-ui-sliderAccess.js"></script>                <script type="text/javascript" src="/jwplayer/jwplayer.js"></script>        		<script language="Javascript" src="javascript/functions.js"></script>				<script language="JavaScript" type="text/JavaScript">				var videoOriginalEndTime = "<?php echo $jsEndTime;?>";	   var videoFriendlyEndTime = "<?php echo $inputEnd;?>";		            function validate() {                var error_msg = "";                                if(trimString(document.frmTrimVideo.trimStart.value) == "") {                    error_msg += "Please Select Start Time. \n";                }                                if(trimString(document.frmTrimVideo.trimEnd.value) == "") {                    error_msg += "Please Select End Time. \n";                }                                //Get Start & End Time                inputStartTime = $('#trimStart').val();                inputEndTime = $('#trimEnd').val();                //alert(varStartTime + '/' + varEndTime);                                                //Compare Start & End Time to each other                var strCompareStartEndTime = compareStartEndtime(inputStartTime,inputEndTime);                                if (strCompareStartEndTime == 0) {                    error_msg += "Start Time must be earlier than End Time. \n";                }                                //Compare End Time to Video End Time                var strValidateEndtimeWithOriginal = compareEndtimeWithOriginal(inputEndTime,videoOriginalEndTime);                if (strValidateEndtimeWithOriginal == 0) {                    error_msg += "End Time must be earlier than Video Duration: " + videoFriendlyEndTime + ". \n";                }                                       //Display Errors                if(error_msg != '') {                    alert(error_msg);                    return false;                } else {                              jwplayer().stop();                    $('p.loading').show();                             $('input:submit').attr("disabled", true);                      $('input:submit').fadeTo("slow", 0.33);                    return true;                }            }                    function compareStartEndtime(dt1,dt2)        {             if (dt1.length < 6 ) {                dt1 = "00:" + dt1;            }                        if (dt2.length < 6 ) {                dt2 = "00:" + dt2;            }            var jdt1=Date.parse('20 Aug 2000 '+dt1);            var jdt2=Date.parse('20 Aug 2000 '+dt2);            var returnval = 0;                    if (jdt1>=jdt2)            {                //alert('start is greater');                returnval = 0;            }            else            {                //alert('start is less equal');                returnval = 1;            }                return returnval;        }                 function compareEndtimeWithOriginal(dt1,dt2)        {             if (dt1.length < 6 ) {                dt1 = "00:" + dt1;            }                        if (dt2.length < 6 ) {                dt2 = "00:" + dt2;            }            var jdt1=Date.parse('20 Aug 2000 '+dt1);            var jdt2=Date.parse('20 Aug 2000 '+dt2);            var returnval = 0;                    if (jdt1>jdt2)            {                //alert('start is greater');                returnval = 0;            }            else            {                //alert('start is less equal');                returnval = 1;            }                return returnval;        }                        function setStartTime()            {                //alert($('#time').html());                curtime = $('#time').html();                $('#trimStart').val(curtime);            }                        function setEndTime()            {                //alert($('#time').html());                curtime = $('#time').html();                $('#trimEnd').val(curtime);            }                     //jQuery AJAX Calls             $(document).ready(function(){          varMaxMinutes = <?php echo $MaxMins;?>;          varMaxSeconds = <?php echo $MaxSeconds;?>;                    //alert(varMaxMinutes);          //alert(varMaxSeconds);                               //Start Trim         $('#trimStart').timepicker({             showHour: <?php echo $showHour;?>,               minuteGrid: 1,             secondGrid: 15,             showMinute: true,               showSecond: true,               showMillisec: false,             timeFormat: <?php echo $timeFormat;?>,             hourMax: <?php echo $MaxHours;?>,             minuteMax: <?php echo $MaxMins;?>,             secondMax: <?php echo $MaxSeconds;?>,              });                  //End Trim         $('#trimEnd').timepicker({             showHour: <?php echo $showHour;?>,               minuteGrid: 1,             secondGrid: 15,             showMinute: true,               showSecond: true,               showMillisec: false,             timeFormat: <?php echo $timeFormat;?>,             hourMax: <?php echo $MaxHours;?>,             minuteMax: <?php echo $MaxMins;?>,             secondMax: <?php echo $MaxSeconds;?>,                      });                           }); //document.ready                        var player = null;          function playerReady(obj)          {            player = gid(obj.id);            addListeners();          };              function addListeners()          {            if(player.getPlaylist())            {               player.addModelListener('TIME', 'timeMonitor');            }            else            {              setTimeout("addListeners()", 1000);            }          };              function timeMonitor(obj)          {            //gid('time').innerHTML = 'Video Position: ' + obj.position;            //curPosition = obj.position;            var includehour = <?php echo $showHour;?>;                        var secs = Math.floor(obj.position);            var hr = Math.floor(secs / 3600);            var min = Math.floor((secs - (hr * 3600))/60);            var sec = secs - (hr * 3600) - (min * 60);                if (hr < 10) { hr = "0" + hr; }            if (min < 10) { min = "0" + min; }            if (sec < 10)  { sec  = "0" + sec; }                if (includehour == true)            {                $("#time").html(hr + ':' + min + ':' + sec);               } else {                $("#time").html(min + ':' + sec);               }                                              };              function gid(name)          {            return document.getElementById(name);          };		</script>	</head>	<body>		<?php        include ('header.php');		?>		<!--header link starts from here -->		<!--Header ends from here -->		<!--middle panel starts from here -->		<!--content panel starts from here -->		<div class="container">			<div class="innerWraper">				<div class="middle-bg">					<div class="cantener">						<div class="register-main">							<div class="registerPage">								<form name="frmTrimVideo" action="" method="post" enctype="multipart/form-data" onsubmit="return validate()" >									<h1>Create Highlight Video (trim this video)</h1>																		<div style="font-size:13px;color:red;margin-bottom:10px;"><b>*NOTE:</b> Creating New Highlight will delete any existing Highlight Videos</div>																										<?php if ($_SESSION['mode']=='athlete') { ?>                                                                              <?                                            if ($_REQUEST['msg'] != "") {echo '<font class="thankyoumessage">' . $_REQUEST['msg'] .'</font>' ;                                            }                                                                                                 if ($_REQUEST['error_msg'] != "") {echo '<font class="errormessage">' . $_REQUEST['error_msg'] .'</font>' ;                                            }                                                                                               ?>                                                                                                <div class="videotrim-container">                                                                        <div id="jwplayer">Loading the Video Player ...</div>                                                                                                <script type="text/javascript">                                        jwplayer("jwplayer").setup({                                            flashplayer: "/jwplayer/player.swf",                                            file: "video/<?php echo $fldVideo;?>",                                            image: "video/<?php echo $imagename;?>",                                            skin: "skins/stormtrooper/stormtrooper.zip",                                            controlbar: "bottom",                                            height: 440,                                            width: 600                                        });                                    </script>                                           <br/>                                    <br />                                    <b>Video Duration: </b> <?php echo $VideoDuration; ?>                                                                                </div>                            <div class="controls-container">                                <h2 style="margin-bottom:20px;font-size:16px;">Step #1 - Set START / END Time:</h2>                                                                <div class="control">                                    <div class="label">START Trim at:</div>                                    <input type="text" name="trimStart" id="trimStart" value="<?php echo $inputStart; ?>" readonly />                                    <button type="button" id="btnSetStart" onclick="setStartTime(); return false;">Get from video position</button>                                                                  </div>                                                              <div class="control" style="margin-bottom:30px;">                                    <div class="label">END Trim at:</div>                                    <input type="text" name="trimEnd" id="trimEnd" value="<?php echo $inputEnd; ?>"  readonly/>                                        <button type="button" id="btnSetEnd" onclick="setEndTime(); return false;">Get from video position</button>                                                                                             </div>                                                                                                <div class="control" style="margin-bottom:50px;">                                    <b>Current Position:</b>&nbsp; <span id="time"><?php echo $inputStart; ?></span>                                </div>                                                                <hr />                                                                  <h2 style="margin-bottom:15px;font-size:16px;">Step #2 - Save Video:</h2>                                                     <p class="loading" style="margin:0;padding:0;line-height:18px;display:none;">                                    <label style="line-height:18px;">&nbsp;</label>                                    <span style="line-height:18px;">                                        <img src="/img/ajax-loader.gif" style="margin:0;vertical-align:middle;" />                                    </span>                                </p>                                <p class="loading" style="margin:0 0 10px 0;padding:0;line-height:18px;display:none;">                                    <label>&nbsp;</label>                                    <font style="font-size:12px;font-style:normal;color:#C12626;">*Trimming Process may take several minutes depending on filesize, do not leave page until process finishes.</font>                                </p>                                                                                                    <div class="control">                                    <input type="hidden" name="hdnVideoFilename" value="<? echo $fldVideo;?>">                                    <input type="hidden" name="hdnVideoTitle" value="<? echo $fldTitle;?>">                                    <input type="hidden" name="isSubmit" value="TrimVideo">                                    <input type="submit" name="submit" value="Save Video" class="normalbtn">                                      </div>                                                            </div>                            <div class="clear"></div>                                                                                                                                                                                                                                                                                                                                                     <?php  }                                    else                                    {                                ?><p><font class="errormessage"><b>Access Denied</b></font></p><?php                                    }                                ?>								</form>							</div>						</div>					</div>				</div>			</div>		</div>		<?php            include ('footer.php');		?>	</body></html>