if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize upload")}if(typeof Control=="undefined"){Control={}}Protoplasm.loadStylesheet("upload.css","upload");Control.FileUpload=Class.create(function(){var a=/[\/\\]/g;return{initialize:function(d,b){d=$(d);if(!d||d.nodeName!="INPUT"||d.type!="file"||!d.form){throw ("element is not a file input.")}if(c=d.retrieve("fileupload")){c.destroy()}b=Object.extend({multiple:false,batch:false,inline:false,progress:true,progressUrl:null,onSuccess:Prototype.emptyFunction,onFailure:Prototype.emptyFunction,onComplete:Prototype.emptyFunction},b||{});wrapper=d.wrap("div");button=d.wrap("div",{"class":"_pp_upload_input _pp_button"}).insert("Select File(s)...");d.setOpacity(0);changeListener=d.on("change",this.fileAdded.bindAsEventListener(this));listeners=[changeListener,Event.on(window,"unload",this.destroy.bind(this))];if(b.inline){listeners.push(d.form.on("submit",this.submit.bindAsEventListener(this)))}d.store("fileupload",this);this.element=d;this.options=b;this.wrapper=wrapper;this.button=button;this.files=wrapper.appendChild(new Element("ul",{"class":"_pp_upload_files"}));this.handler=this.createHandler();this.uploads=[];this.changeListener=changeListener;this.listeners=listeners},createHandler:function(){if(typeof File!="undefined"&&typeof Ajax.getTransport().upload!="undefined"&&this.options.progress){return new Control.FileUpload.AjaxHandler(this)}else{return new Control.FileUpload.IFrameHandler(this)}},fileAdded:function(d){var b=this.element;var f=$H(this.handler.add(b));f.each(function(l){var g=l.key;var e=l.value;if(!this.options.multiple){for(var h=0;h<this.uploads.length;h++){this.cancel(h);this.uploads[h]&&this.uploads[h].remove()}}var p=new Element("li");p.appendChild(new Element("div",{"class":"_pp_upload_progress"}));p.appendChild(new Element("div",{"class":"_pp_upload_label"})).update(e);p.appendChild(b);this.files.appendChild(p);if(this.options.multiple){this.changeListener.stop();var j=new Element("div",{"class":"_pp_upload_change"});var n=j.appendChild(new Element("img",{src:Protoplasm.base("upload")+"remove.png"}));n.on("click",function(i){if(!(g in this.uploads&&this.handler.cancel(g))){p.remove()}Event.stop(i)}.bindAsEventListener(this));p.insert({top:j});var o=b.clone();o.store("fileupload",this);var k=o.on("change",this.fileAdded.bindAsEventListener(this));this.listeners.push(k);this.changeListeners=k;this.button.insert({top:o});b.hide();this.element=o}else{var m=new Element("div",{"class":"_pp_upload_change"});var n=m.appendChild(new Element("img",{src:Protoplasm.base("upload")+"change.png"}));p.insert({top:m});this.button.hide()}this.uploads[g]=p;if(!this.options.batch&&this.options.inline){this.upload(g)}}.bind(this))},destroy:function(){for(var b=0;b<this.listeners.length;++b){this.listeners[b].stop()}this.wrapper.replace(this.element);this.element.show();this.element.store("fileupload",null)},submit:function(d){if(d){Event.stop(d)}for(var b=0;b<this.uploads.length;++b){this.upload(b)}},upload:function(d){if(d in this.uploads){var b=this.uploads[d];b.down("div._pp_upload_label").addClassName("_pp_upload_loading");this.handler.upload(d)}},cancel:function(){for(var b=0;b<this.uploads.length;++b){this.handler.cancel(b)}},onProgress:function(g,b,e){if(g in this.uploads){var f=this.uploads[g];var d=f.getLayout().get("width")*(b/e);f.down("div._pp_upload_progress").style.width=d+"px"}},onSuccess:function(e,b,d){this.options.onSuccess(b);this.uploadComplete(e,b,d,true)},onFailure:function(e,b,d){this.options.onFailure(b);this.uploadComplete(e,b,d,false)},uploadComplete:function(h,b,e,g){if(h in this.uploads){var f=this.uploads[h];var d=f.down("div._pp_upload_label");d.removeClassName("_pp_upload_loading");f.down("div._pp_upload_progress").remove();f.down("div._pp_upload_change").remove();if(g){f.addClassName("_pp_upload_success");d.addClassName("_pp_upload_complete")}else{f.addClassName("_pp_upload_error");d.addClassName("_pp_upload_failed")}delete this.uploads[h]}if(this.uploads.filter(Prototype.K).size()==0){this.options.onComplete(b)}e.remove()},basename:function(b){return b?b.split(a).pop():b},dirname:function(b){return b&&b.match(a)?b.split(a).slice(0,-1).join("/"):""}}}());Control.FileUpload.AjaxHandler=Class.create(function(){return{initialize:function(d){this.control=d;this.action=d.element.form.action;this.method=d.element.form.method;this.params=null;if(fields=d.options.includeFields){var a={};var b=d.element.form.elements;fields.each(function(e){a[e]=b[e].value});this.params=$H(a).toQueryString()}this.uploads={};this.active={}},add:function(a){accepted={};if(a.files){$A(a.files).each(function(b){var d=Control.FileUpload.activeCount++;this.uploads[d]=[a,b];accepted[d]=b.name}.bind(this))}else{throw ("Browser does not support XHR File API")}return accepted},upload:function(g){if(g in this.uploads){u=this.uploads[g];var b=u[0];var d=u[1];var a=d.name?d.name:this.control.basename(d.value);var f={"Content-Disposition":"attachment; filename="+a};if(this.params){f["X-Upload-Parameters"]=this.params}var e=new Ajax.UploadRequest(this.action,{method:this.method,contentType:"application/octet-stream",requestHeaders:f,postBody:d,onProgress:function(h,i){this.control.onProgress(g,h,i)}.bind(this),onSuccess:function(h){delete this.uploads[g];if(this.active[g]){delete this.active[g];this.control.onSuccess(g,a,b)}}.bind(this),onFailure:function(h){delete this.uploads[g];if(this.active[g]){delete this.active[g];this.control.onFailure(g,a,b)}}.bind(this)});this.active[g]=e}},cancel:function(g){if(g in this.uploads){if(g in this.active){var d=this.uploads[g];var b=d[0];var e=d[1];var a=e.name?e.name:this.control.basename(e.value);var f=this.active[g].transport;delete this.active[g];f.abort();this.control.onFailure(g,a,b);return true}delete this.uploads[g]}return false}}}());Control.FileUpload.IFrameHandler=Class.create(function(){return{initialize:function(d){this.control=d;this.progressUrl=d.options.progressUrl;var a={};if(fields=d.options.includeFields){var b=d.element.form.elements;fields.each(function(e){a[e]=b[e].value})}this.params=$H(a);this.uploads={}},add:function(a){var b=Control.FileUpload.activeCount++;this.uploads[b]=a;accepted={};if(a.multiple&&a.files){accepted[b]=$A(a.files).pluck("name").join("<br />\n")}else{accepted[b]=this.control.basename(a.value)}return accepted},upload:function(e){if(e in this.uploads){file=this.uploads[e];file.store("parent",file.parentNode);var b=file.parentNode.appendChild(new Element("iframe",{name:"upload_iframe_"+e,"class":"_pp_upload_iframe"}));b.store("load",b.on("load",this.completeListener(e,file,this.control.onSuccess.bind(this.control))));b.store("error",b.on("error",this.completeListener(e,file,this.control.onFailure.bind(this.control))));var d=new Element("form",{action:file.form.action,method:file.form.method,enctype:"multipart/form-data",target:b.name});d.store("iframe",b);d.appendChild(file);if(this.params.size()){this.params.each(function(g){d.appendChild(new Element("input",{type:"hidden",name:g.key,value:g.value}))})}d.hide();document.body.appendChild(d);d.submit();if(this.progressUrl){var a=this.progressHandler(e,file);this.progressChecker=setTimeout(function(){a(a)},1000)}return[e]}},completeListener:function(d,a,b){return function(f){a.form.remove();a.retrieve("parent").appendChild(a);if(b){if(a.multiple&&a.files){$A(a.files).each(function(e){b(d,e.name,a)})}else{b(d,this.control.basename(a.value),a)}}if(this.progressChecker){clearTimeout(this.progressChecker);this.progressChecker=null}}.bind(this)},cancel:function(d){if(d in this.uploads){var a=this.uploads[d];var b=a.form.retrieve("iframe");delete this.uploads[d];if(b){b.retrieve("load").stop();b.retrieve("error").stop();b.src="javascript:false;";this.completeListener(d,a,this.control.onFailure.bind(this.control))();return true}}return false},checkProgressLater:function(a){if(this.progressChecker){this.progressChecker=setTimeout(function(){a(a)},1000)}},progressHandler:function(d,a){if(this.progressUrl){var b=this.progressUrl.toQueryParams();if(a.multiple&&a.files){b.files=a.files.pluck("name").map(escape).join(",")}else{b.files=escape(this.control.basename(a.value))}return function(e){new Ajax.Request(this.progressUrl,{parameters:b,onSuccess:function(f){console.log(f.responseText);this.checkProgressLater(e)}.bind(this),onFailure:function(f){this.checkProgressLater(e)}.bind(this)})}.bind(this)}return Prototype.emptyFunction}}}());Control.FileUpload.activeCount=0;Ajax.UploadRequest=Class.create(Ajax.Request,{initialize:function($super,b,a){Ajax.Base.prototype.initialize.bind(this)(a);this.transport=Ajax.getTransport();if(a.onProgress){if(this.transport.upload){this.transport.upload.addEventListener("progress",function(f){a.onProgress(f.loaded,f.total)}.bindAsEventListener(this),false)}else{try{this.transport.onprogress=function(f){a.onProgress(f.position,f.totalSize)}.bindAsEventListener(this)}catch(d){}}}this.request(b)}});Protoplasm.register("upload",Control.FileUpload);