if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize filechooser")}if(typeof Control=="undefined"){Control={}}Protoplasm.use("dialog");Protoplasm.use("upload");Protoplasm.loadStylesheet("filechooser.css","filechooser");Control.FileChooser=Class.create({initialize:function(b,d,a){this.element=$(b);if(fc=this.element.retrieve("filechooser")){fc.destroy()}this.options=a||{};var c=Protoplasm.base("filechooser");if(!this.options.icon){this.options.icon=c+"filechooser.png"}if(!this.options.fileImage){this.options.fileImage=c+"file.gif"}if(!this.options.directoryImage){this.options.directoryImage=c+"directory.gif"}if(!this.options.parentImage){this.options.parentImage=c+"parent.gif"}if(this.options.icon){this.element.style.background="url("+this.options.icon+") right center no-repeat #FFF";this.oldPadding=this.element.style.paddingRight;this.element.style.paddingRight="20px"}this.panel=new Control.FileChooser.Panel(d,Object.extend({openListener:this.fileSelected.bind(this),standalone:true,selectFile:this.element.value},this.options||{}));this.dialogOpen=false;this.dialog=this.panel.getElement();this.listeners=[this.element.on("click",this.toggle.bindAsEventListener(this)),this.element.on("blur",this.delayedHide.bindAsEventListener(this)),this.dialog.on("click",this.cancelHide.bindAsEventListener(this)),this.element.on("keydown",this.keyHandler.bindAsEventListener(this))];this.clickListener=null;this.keyListener=null;this.element.store("filechooser",this);this.destructor=Event.on(window,"unload",this.destroy.bind(this))},destroy:function(){this.hide();for(var a=0;a<this.listeners.length;a++){this.listeners[a].stop()}if(this.clickListener){this.clickListener.stop()}if(this.keyListener){this.keyListener.stop()}this.element.style.paddingRight=this.oldPadding;this.element.store("filechooser",null);this.destructor.stop()},fileSelected:function(a){if(a){this.element.value=a.url}this.hide()},toggle:function(){if(this.dialogOpen){this.hide()}else{this.show()}},show:function(){if(!this.dialogOpen){var c=Element.getDimensions(this.element);var a=Position.cumulativeOffset(this.element);var b=/MSIE/.test(navigator.userAgent)?(a[1]+c.height)+"px":(a[1]+c.height-1)+"px";this.dialog.style.top=b;this.dialog.style.left=a[0]+"px";if(this.element.value){this.panel.select(this.element.value)}else{this.panel.refresh()}document.body.appendChild(this.dialog);this.clickListener=document.on("click",this.documentClickHandler.bindAsEventListener(this));this.keyListener=document.on("keydown",this.escHandler.bindAsEventListener(this));this.dialogOpen=true}},delayedHide:function(a){this.hideTimeout=setTimeout(this.hide,100)},cancelHide:function(a){if(this.hideTimeout){clearTimeout(this.hideTimeout);this.hideTimeout=null}},hide:function(){if(this.dialogOpen){if(this.clickListener){this.clickListener.stop();this.clickListener=null}if(this.keyListener){this.keyListener.stop();this.keyListener=null}if(this.dialog.parentNode){Element.remove(this.dialog)}this.dialogOpen=false}},keyHandler:function(a){switch(a.keyCode){case Event.KEY_DOWN:this.show();break}},escHandler:function(a){switch(a.keyCode){case Event.KEY_ESC:this.hide();break}},documentClickHandler:function(b){var a=Event.element(b);var c=false;do{if(a==this.dialog||a==this.element||(Dialog.active&&(a==Dialog.active.contents||a==Dialog.active.overlay))){c=true}}while(a=a.parentNode);if(!c){this.hide()}}});Control.FileChooser.Panel=Class.create({initialize:function(a,b){this.fileLister=a||Prototype.emptyFunction;this.options=Object.extend({width:360,height:220,className:"",fileImage:"/images/icons/file.gif",directoryImage:"/images/icons/directory.gif",parentImage:"/images/icons/parent.gif",uploadProgress:false},b||{});this.uploadHandler=this.options.uploadProgress?this.showAdvancedUploadDialog.bind(this):this.showUploadDialog.bind(this);this.element=this.createFileChooser();if(this.options.selectFile){this.select(this.options.selectFile)}},getElement:function(){return this.element},createFileChooser:function(){var e=new Element("div");this.directoryHeader=new Element("div",{"class":"_pp_filechooser_directoryheader",style:"margin-bottom:5px;"}).update("&nbsp;");e.appendChild(this.directoryHeader);var k=new Element("table");k.cellSpacing=0;k.cellPadding=0;k.style.border=0;var l=k.insertRow(0);var f=this.options.height-40;var c=Math.round((this.options.width-6)*0.3);var d=this.options.height-61;var i=this.options.width-c-10;var j=l.insertCell(0);j.vAlign="top";this.fileList=new Element("div",{"class":"_pp_panel _pp_inset",style:"height:"+d+"px;width"+i+"px;overflow:auto;margin-right:3px;margin-bottom:5px;"});this.fileList.on("mousedown",function(){return false});this.fileList.on("selectstart",function(){return false});j.appendChild(this.fileList);this.createButton=new Element("input",{type:"button",value:"New Folder","class":"_pp_button",style:"margin-right:5px;width:"+Math.round((i-10)/3)+"px"});this.createButton.on("click",this.showDirectoryCreateDialog.bindAsEventListener(this));this.uploadButton=new Element("input",{type:"button",value:"New File","class":"_pp_button",style:"margin-right:5px;width:"+Math.round((i-10)/3)+"px"});this.uploadButton.on("click",function(m){this.uploadHandler(this)}.bindAsEventListener(this));this.deleteButton=new Element("input",{type:"button",value:"Delete","class":"_pp_button",style:"width:"+Math.round((i-10)/3)+"px"});this.deleteButton.on("click",this.showDeleteDialog.bindAsEventListener(this));var g=new Element("div");g.appendChild(this.createButton);g.appendChild(this.uploadButton);g.appendChild(this.deleteButton);j.appendChild(g);j=l.insertCell(1);j.vAlign="top";this.filePreview=new Element("div",{"class":"_pp_filechooser_preview _pp_inset",style:"height:"+f+"px;width:"+c+"px;margin-left:3px;margin-bottom:5px;overflow:hidden;position:relative"});j.appendChild(this.filePreview);e.appendChild(k);document.on("keydown",this.keyPressListener());if(this.options.standalone){var b=new Element("form");b.style.margin=0;var k=new Element("table");k.cellSpacing=0;k.cellPadding=0;k.border=0;var l=k.insertRow(0);var j=l.insertCell(0);this.fileLocation=new Element("input",{type:"text",readOnly:true,style:"width:245px;margin-right:5px"});j.appendChild(this.fileLocation);j=l.insertCell(1);j.style.textAlign="right";var h=new Element("input",{type:"button",value:"Cancel","class":"_pp_button",style:"width:50px;margin-right:5px;"});h.on("click",function(m){Element.remove(this.getElement())}.bindAsEventListener(this));j.appendChild(h);j=l.insertCell(2);j.style.textAlign="right";var h=new Element("input",{type:"button",value:"Select","class":"_pp_button",style:"width:50px;"});h.on("click",function(m){(this.options.openListener||Prototype.emptyFunction)(this.selectedFile)}.bindAsEventListener(this));j.appendChild(h);b.appendChild(k);e.appendChild(b);var a=new Element("div");a.style.position="absolute";a.appendChild(e);a.className="_pp_frame _pp_filechooser "+this.options.className;return a}else{e.className="_pp_frame _pp_filechooser "+this.options.className;return e}},select:function(b){this.filePreview.innerHTML="";this.fileList.innerHTML='<div style="padding:3px">Loading file list...</div>';this.selectedFile=null;var a=this.fileLister(null,this.selectByURL(b).bind(this));if(a){this.selectByURL(b)(a)}},selectByURL:function(a){return function(b){console.log(b);if(b.status!="error"&&a&&a.indexOf(b.url)==0){var d=a.substr(b.url.length);var c=d.substr(0,d.lastIndexOf("/"));this.pendingSelect=a;if(c!=b.path){this.refresh(c);return}}this.populateFileList(b)}.bind(this)},refresh:function(a){if(!a&&this.currentDirectory){a=this.currentDirectory.path}Dialog.close();this.filePreview.update();this.fileList.update('<div style="padding:3px">Loading file list...</div>');this.selectedFile=null;var b=this.fileLister(a,this.populateFileList.bind(this));if(b){this.populateFileList(b)}},populateFileList:function(b){if(b.status=="error"){this.fileList.update('<div style="padding:3px">Could not get directory contents.</div>');return}this.currentDirectory=b;this.entries=[];this.directoryHeader.update("<b>Folder:</b> "+(b.path||"/"));this.fileList.update();if(b.parent){this.entries[this.entries.length]={image:"parent",type:"directory",name:"Parent folder",path:b.parent}}if(b.files){if(b.files.constructor==Array){b.files.each(function(i){this.entries.push(i)}.bind(this))}else{this.entries.push(b.files)}}if(this.entries.length){var g=new Element("table");var a=null;g.cellSpacing=0;g.cellPadding=0;g.width="100%";g.style.border=3;this.entries.each(function(j){var i=this.createFileRow(j,g);if(this.pendingSelect&&this.pendingSelect==j.url){this.selectRow(j);a=i;this.pendingSelect=null}}.bind(this));this.fileList.appendChild(g);if(a){var f=g.offsetHeight;var c=this.fileList.offsetHeight;var d=a.offsetTop;var e=d+a.offsetHeight;if(e>c){var h=Math.round(d-(c/2));if(h+c>f){this.fileList.scrollTop=f-c}else{this.fileList.scrollTop=h}}}}else{this.fileList.update('<div style="padding:3px">To add items to your folder, please click <b>New Folder</b> or <b>New File</b> below.</div>')}if(b.fileManager){this.createButton.disabled=false;this.uploadButton.disabled=false}else{this.createButton.disabled=true;this.uploadButton.disabled=true}},showAdvancedUploadDialog:function(a){this.showUploadDialog(a,true)},showUploadDialog:function(j,a){var b=new Element("form",{method:"post",action:this.currentDirectory.fileManager,style:"padding: 12px;width:300px;"});var l=this.currentDirectory.path||"";b.appendChild(new Element("input",{type:"hidden",name:"a",value:"upload"}));b.appendChild(new Element("input",{type:"hidden",name:"p",value:(this.currentDirectory.path||"")}));var i=new Element("div",{style:"float:left;width:60px;padding-top:3px;"}).update("Files:");b.appendChild(i);var d=new Element("input",{type:"file",name:"i",multiple:"multiple"});b.appendChild(d);b.appendChild(new Element("br"));var h=new Element("div",{style:"float:right;"});var k=new Element("input",{type:"button",value:"Close","class":"_pp_button"});k.on("click",function(m){Dialog.close();Event.stop(m)}.bindAsEventListener(this));h.appendChild(k);h.appendChild(new Element("input",{type:"submit",value:"Upload Files","class":"_pp_button"}));b.appendChild(h);b.appendChild(new Element("div",{style:"clear:both;"}));var e=false;var f=new Control.FileUpload(d,{multiple:true,inline:true,batch:true,progress:a,includeFields:["a","p"],prependPath:l,onFailure:function(){e=true},onComplete:function(){if(!e){Dialog.close()}}.bind(this)});var c=new Element("div",{"class":"_pp_dialog _pp_panel"});c.appendChild(new Element("div",{"class":"_pp_title"}).update("Upload Files"));c.appendChild(b);var g=new Dialog.HTML(c,{onClose:function(){this.refresh()}.bind(this)});g.show()},showDeleteDialog:function(){var c=this.selectedFile.type=="directory"?"Are you sure you want to PERMANENTLY delete this folder\nand all files and folders in it?":"Are you sure you want to PERMANENTLY delete this file?";if(this.selectedFile&&confirm(c)){var b=this.currentDirectory.fileManager;var a={parameters:"a=delete&p="+(this.currentDirectory.path||"")+"&f="+this.selectedFile.name,onSuccess:function(d){this.refresh(this.currentDirectory.path)}.bindAsEventListener(this),onFailure:function(d){this.refresh(this.currentDirectory.path);alert(d.responseText)}.bindAsEventListener(this)};this.filePreview.innerHTML="";this.fileList.innerHTML="Loading file list...";new Ajax.Request(b,a)}},showDirectoryCreateDialog:function(){var a=prompt("Enter a folder name:","");if(a){this.createDirectory(a)}},createDirectory:function(c){var b=this.currentDirectory.fileManager;var a={parameters:"a=createdir&p="+(this.currentDirectory.path||"")+"&d="+c,onSuccess:this.createDirectorySuccessful.bind(this),onFailure:this.createDirectoryFailed.bind(this)};this.filePreview.innerHTML="";this.fileList.innerHTML="Loading file list...";new Ajax.Request(b,a)},createDirectorySuccessful:function(a){this.refresh(this.currentDirectory.path)},createDirectoryFailed:function(a){this.refresh(this.currentDirectory.path);alert(a.responseText)},showPreview:function(b){while(this.filePreview.firstChild){Element.remove(this.filePreview.firstChild)}var c=b.substring(b.lastIndexOf(".")+1);if(!c||!$w("jpeg jpg gif png bmp").include(c.toLowerCase())){return}var d=new Element("img");var a=false;d.onload=function(j){if(!a){a=true;var l=d.width;var k=d.height;var i=this.filePreview.offsetWidth-6;var h=this.filePreview.offsetHeight-6;var g=d.width/i;var f=d.height/h;if(g>1&&g>=f){d.width=Math.floor(d.width/g);d.height=Math.floor(d.height/g)}else{if(f>1){d.width=Math.floor(d.width/f);d.height=Math.floor(d.height/f)}}d.setStyle({position:"absolute",top:Math.round((h-d.height)/2)+"px",left:Math.round((i-d.width)/2)+"px",backgroundColor:"#FFFFFF",border:1});this.filePreview.appendChild(d);if(this.options.previewListener){this.options.previewListener(l,k)}}}.bindAsEventListener(this);d.onerror=function(f){while(this.filePreview.firstChild){Element.remove(this.filePreview.firstChild)}if(this.options.previewListener){this.options.previewListener("","")}}.bindAsEventListener(this);d.src=b},createFileRow:function(b,c){var e=c.insertRow(c.rows.length);var a=e.insertCell(0);a.className="_pp_filechooser_filerow";a.width=10;a.appendChild(new Element("img",{src:this.options[(b.image||b.type)+"Image"]}));a=e.insertCell(1);a.className="_pp_filechooser_filerow";a.appendChild(new Element("div",{style:"overflow:hidden;"}).update(b.name));a=e.insertCell(2);a.className="_pp_filechooser_filerow";a.align="right";if(b.size!==undefined){var d;if(b.type=="directory"){d=b.size+" items"}else{d=this.formatFileSize(b.size)}a.innerHTML="<nobr>"+d+"</nobr>"}else{a.innerHTML="&nbsp;"}e.onmousedown=this.fileSelectListener(b);if(b.type=="file"){e.ondblclick=this.fileOpenListener(b)}else{e.ondblclick=this.directoryOpenListener(b)}e.onselectstart=function(){return false};b.element=e;return e},formatFileSize:function(a){if(!a){a=0}if(a<1024){return a+" bytes"}else{if(a<1024*1024){return this.twoDecimals(a/1024)+" KB"}else{return this.twoDecimals(a/(1024*1024))+" MB"}}},twoDecimals:function(a){return Math.round(a*100)/100},fileSelectListener:function(a){return function(b){this.selectRow(a);return false}.bindAsEventListener(this)},directoryOpenListener:function(a){return function(b){this.refresh(a.path)}.bindAsEventListener(this)},fileOpenListener:function(a){return function(b){if(this.options.openListener){this.options.openListener(a)}}.bindAsEventListener(this)},keyPressListener:function(){return function(b){if(this.element.parentNode){switch(b.keyCode){case Event.KEY_DELETE:this.showDeleteDialog();break;case Event.KEY_RETURN:if(this.selectedFile){if(this.selectedFile.type=="file"){this.fileOpenListener(this.selectedFile)()}else{this.directoryOpenListener(this.selectedFile)()}}break;case Event.KEY_UP:var a=this.selectedIndex()-1;if(a<0){a=0}this.selectRow(this.entries[a]);break;case Event.KEY_DOWN:var a=this.selectedIndex()+1;if(a>=this.entries.length){a=this.entries.length-1}this.selectRow(this.entries[a]);break;case 33:var c=Math.floor(this.fileList.offsetHeight/this.entries[0].element.offsetHeight);var a=this.selectedIndex()-c;if(a<0){a=0}this.selectRow(this.entries[a]);break;case 34:var c=Math.floor(this.fileList.offsetHeight/this.entries[0].element.offsetHeight);var a=this.selectedIndex()+c;if(a>=this.entries.length){a=this.entries.length-1}this.selectRow(this.entries[a]);break;case 35:if(this.entries){this.selectRow(this.entries[this.entries.length-1])}break;case 36:if(this.entries){this.selectRow(this.entries[0])}break;default:return}Event.stop(b)}}.bindAsEventListener(this)},selectRow:function(a){if(this.selectedFile!=a){if(this.selectedFile){Element.removeClassName(this.selectedFile.element,"_pp_highlight")}this.selectedFile=a;Element.addClassName(a.element,"_pp_highlight");if(a.url){this.showPreview(a.url);if(this.options.standalone){this.fileLocation.value=a.url}if(this.options.selectListener){this.options.selectListener(a.url)}}else{this.showPreview("");if(this.options.selectListener){this.options.selectListener("")}}}if(a.element.offsetTop<this.fileList.scrollTop){this.fileList.scrollTop=a.element.offsetTop}else{if(a.element.offsetTop+a.element.offsetHeight>this.fileList.scrollTop+this.fileList.offsetHeight){this.fileList.scrollTop=(a.element.offsetTop+a.element.offsetHeight)-this.fileList.offsetHeight}}},selectedIndex:function(){for(index=0;index<this.entries.length;++index){if(this.entries[index]==this.selectedFile){return index}}return -1}});Protoplasm.register("filechooser",Control.FileChooser);