if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize colorpicker")}if(typeof Control=="undefined"){Control={}}Control.ColorPicker=Class.create({initialize:function(f,c){f=$(f);if(cp=f.retrieve("colorpicker")){cp.destroy()}this.options=Object.extend({},c||{});this.panel=new Control.ColorPicker.Panel({onSelect:this.colorSelected.bind(this)});this.opened=false;this.dialog=new Element("div",{style:"position:absolute;"});var b=new Element("div",{"class":"_pp_frame_small "+this.options.className});b.appendChild(this.panel.element);this.dialog.appendChild(b);wrapper=f.wrap(new Element("div",{"class":"inline-block"}));wrapper.style.position="relative";wrapper.style.zIndex="99";var g=f.getLayout();var e=g.get("height")-2;var a=g.get("padding-top");if(a<1){a=1;e-=(a-g.get("padding-top"))*2}var d=g.get("padding-right");if(d<1){d=1}this.swatch=new Element("div",{"class":"inputExtension",title:"Open color palette",style:"border:1px solid gray;position:absolute;fontSize:1px;display:inline-block;width:"+e+"px;height:"+e+"px;background-color:"+f.value});f.insert({after:this.swatch});console.log(g.get("right"));this.swatch.style.top=(g.get("top")+a+g.get("border-top"))+"px";this.swatch.style.right=(g.get("right")-e-3+g.get("border-right"))+"px";this.oldPadding=f.style.paddingRight;f.style.paddingRight=(e+3+g.get("padding-left")+d)+"px";f.maxLength=7;this.listeners=[f.on("change",this.textChanged.bindAsEventListener(this)),f.on("blur",this.close.bindAsEventListener(this)),this.swatch.on("click",this.toggle.bindAsEventListener(this)),this.swatch.on("selectstart",Event.stop),Event.on(window,"unload",this.destroy.bind(this))];this.clickListener=null;f.store("colorpicker",this);f._show=f.show;f._hide=f.hide;this.element=Protoplasm.extend(f,{show:wrapper.show.bind(wrapper),hide:wrapper.hide.bind(wrapper),open:this.open.bind(this),toggle:this.toggle.bind(this),close:this.close.bind(this),destroy:this.destroy.bind(this)});this.wrapper=wrapper},destroy:function(){Protoplasm.revert(this.element);this.listeners.invoke("stop");if(this.clickListener){this.clickListener.stop()}var a=this.element;this.wrapper.parentNode.replaceChild(a,this.wrapper);a.style.paddingRight=this.oldPadding;a.store("colorpicker",null)},colorSelected:function(a){this.element.value=a;this.swatch.style.backgroundColor=a;this.close()},textChanged:function(a){this.swatch.style.backgroundColor=this.element.value},toggle:function(a){if(this.opened){this.close()}else{this.open()}},open:function(c){if(!this.opened){var b=this.element.getLayout();document.body.appendChild(this.dialog);var a=b.get("border-box-height")-b.get("border-bottom");this.dialog.clonePosition(this.element,{setWidth:false,setHeight:false,offsetTop:a,offsetLeft:-3});this.clickListener=document.on("click",this.clickHandler.bindAsEventListener(this));this.opened=true}},close:function(a){if(this.opened){if(this.clickListener){this.clickListener.stop()}this.dialog.remove();this.opened=false}},clickHandler:function(b){var a=Event.element(b);do{if(a==this.swatch||a==this.dialog){return}}while(a=a.parentNode);this.close()}});Control.ColorPicker.Panel=Class.create({initialize:function(a){this.options=Object.extend({addLabel:"Add",colors:Array("#000000","#993300","#333300","#003300","#003366","#000080","#333399","#333333","#800000","#FF6600","#808000","#008000","#008080","#0000FF","#666699","#808080","#FF0000","#FF9900","#99CC00","#339966","#33CCCC","#3366FF","#800080","#969696","#FF00FF","#FFCC00","#FFFF00","#00FF00","#00FFFF","#00CCFF","#993366","#C0C0C0","#FF99CC","#FFCC99","#FFFF99","#CCFFCC","#CCFFFF","#99CCFF","#CC99FF","#FFFFFF"),onSelect:Prototype.emptyFunction},a||{});this.customSwatches=[];this.activeCustom=null,this.element=this.create()},create:function(){var q=document.createElement("div");var a=this.options.colors;var p,n;var o=new Element("table",{cellPadding:0,cellSpacing:0,border:0});for(var f=0;f<5;++f){p=o.insertRow(f);for(var e=0;e<8;++e){n=p.insertCell(e);Element.setStyle(n,{border:"0px",padding:"0px"});var d=a[(8*f)+e];var m=new Element("div",{style:"width:15px;height:15px;font-size:1px;border:1px solid #EEEEEE;background-color:"+d+";padding:0"});m.on("click",this.clickListener(d));m.on("mouseover",this.hoverListener(d));n.appendChild(m)}}this.addSpacerRow(o,5);p=o.insertRow(6);var k=this.loadSetting("customColors")?this.loadSetting("customColors").split(","):new Array();this.customSwatches=[];for(var f=0;f<8;++f){n=p.insertCell(f);Element.setStyle(n,{border:"0",padding:"0"});var d=k[f]?k[f]:"#000000";var m=new Element("div",{style:"width:15px;height:15px;fontSize:15px;border:1px solid #EEEEEE;background-color:"+d+";padding:0"});n.appendChild(m);m.on("click",this.customClickListener(d,m));m.on("mouseover",this.hoverListener(d));this.customSwatches.push(m)}this.addSpacerRow(o,7);p=o.insertRow(8);n=p.insertCell(0);Element.setStyle(n,{border:"0",padding:"0"});n.colSpan=8;var b=new Element("table",{cellspacing:0,cellpadding:0,border:0,style:"width:136px;"});n.appendChild(b);p=b.insertRow(0);n=p.insertCell(0);Element.setStyle(n,{border:"0",padding:"0","vertical-align":"middle"});var g=new Element("div",{style:"width:15px;height:15px;fontSize:15px;border:1px solid #EEEEEE;background-color:#000000"});n.appendChild(g);this.previewSwatch=g;n=p.insertCell(1);Element.setStyle(n,{border:"0",padding:"0","vertical-align":"middle","text-align":"center"});var l=new Element("input",{type:"text",value:"#000000",style:"width:70px;border:1px solid gray"});l.on("keyup",function(i){this.previewSwatch.style.backgroundColor=l.value}.bindAsEventListener(this));n.appendChild(l);this.customInput=l;n=p.insertCell(2);Element.setStyle(n,{border:"0",padding:"0","vertical-align":"middle","text-align":"right"});var h=new Element("input",{type:"button",value:this.options.addLabel,style:"width:40px;border:1px solid gray"});h.on("click",function(s){var j=0;if(this.activeCustom){for(var r=0;r<this.customSwatches.length;++r){if(this.customSwatches[r]==this.activeCustom){j=r;break}}this.activeCustom.style.border="1px solid #EEEEEE";this.activeCustom=null}else{var t=this.loadSetting("customColorIndex");if(t){j=(parseInt(t)+1)%8}}this.saveSetting("customColorIndex",j);k[j]=this.customSwatches[j].style.backgroundColor=this.customInput.value;this.customSwatches[j].onclick=this.customClickListener(k[j],this.customSwatches[j]);this.customSwatches[j].onmouseover=this.hoverListener(k[j]);this.saveSetting("customColors",k.join(","))}.bindAsEventListener(this));n.appendChild(h);var c=new Element("form",{style:"margin:0;padding:0"});c.onsubmit=function(){if(this.activeCustom){this.activeCustom.style.border="1px solid #EEEEEE"}this.activeCustom=null;this.editor.setDialogColor(this.customInput.value);return false}.bindAsEventListener(this);c.appendChild(o);q.appendChild(c);return q},addSpacerRow:function(b,a){var c=b.insertRow(a);cell=c.insertCell(0);cell.colSpan=8;Element.setStyle(cell,{border:"0",padding:"0"});cell.appendChild(new Element("hr",{style:"color:gray;background-color:gray;height:1px;border:0;margin-top:3px;margin-bottom:3px;padding:0"}));return c},clickListener:function(a){return function(b){if(this.activeCustom){this.activeCustom.style.border="1px solid #EEEEEE"}this.activeCustom=null;this.options.onSelect(a)}.bindAsEventListener(this)},customClickListener:function(a,b){return function(c){if(c.ctrlKey){if(this.activeCustom){this.activeCustom.style.border="1px solid #EEEEEE"}this.activeCustom=b;this.activeCustom.style.border="1px solid #FF0000"}else{this.activeCustom=null;this.options.onSelect(a)}}.bindAsEventListener(this)},hoverListener:function(a){return function(b){this.previewSwatch.style.backgroundColor=a;this.customInput.value=a}.bindAsEventListener(this)},loadSetting:function(b){b="colorpicker_"+b;var e=b+"=";var a=document.cookie.split(";");for(var d=0;d<a.length;d++){var f=a[d];while(f.charAt(0)==" "){f=f.substring(1,f.length)}if(f.indexOf(e)==0){return f.substring(e.length,f.length)}}return null},saveSetting:function(c,d,e){c="colorpicker_"+c;if(!e){e=180}var b=new Date();b.setTime(b.getTime()+(e*24*60*60*1000));var a="; expires="+b.toGMTString();document.cookie=c+"="+d+a+"; path=/"},clearSetting:function(a){this.saveSetting(a,"",-1)}});Protoplasm.register("colorpicker",Control.ColorPicker);