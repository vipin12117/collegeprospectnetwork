<?phpinclude_once 'inc/common_functions.php';include_once 'inc/page.inc.php';// TODO: Add a form token to make sure people aren't spoofing form datasession_start();if (($_SESSION['mode'] == "") or ($_SESSION['FRONTEND_USER'] == "")) {    header("Location:index.php");}$func = new COMMONFUNC;$db = new DB;$flag = 0;/* * gets coach information. This is used to pre-fill form fields  * and provide necessary data for the Authorize.net transaction */$query = 'SELECT * FROM ' . TBL_COLLEGE_COACH_REGISTER .         " WHERE fldUserName='" . $_SESSION[FRONTEND_USER] . "'";$db->query($query);$db->next_record();$fldCoach = $db -> f('fldId');$fldCollegename = $db -> f('fldCollegename');$fldtransectionId = $db -> f('fldtransectionId');$fldCancelCount = $db -> f('fldCancelCount');$fldSubscribe = $db->f('fldSubscribe');// gets all active subscriptions for the current user// gets available subscription types for the form$table  = TBL_COLLEGE_SUBSCRIPTION;$fields = 'fldId,fldType,fldSport';$where  = 'WHERE fldCoach=' . $fldCoach . ' AND fldActive=1';$subsList = $func->selectTableOrder($table, $fields, 'fldId', $where);$subsCount = count($subsList);// creates a human-readable version of the active subscriptions$activeSubs = array();for ($i = 0; $i < $subsCount; $i++) {    $key = $subsList[$i]['fldId'];        // gets the name of the subscription type    $query = 'SELECT fldName FROM ' . TBL_SUBSCRIPTION .              ' WHERE fldId=' . $subsList[$i]['fldType'];    $db->query($query);    $db->next_record();        $typeName = $db->f('fldName');        // gets the name of the subscribed sport    $query = 'SELECT fldSportsname FROM ' . TBL_SPORTS .             ' WHERE fldId=' . $subsList[$i]['fldSport'];    $db->query($query);    $db->next_record();        $sportName = $db->f('fldSportsname');        $value = $typeName . ' (' . $sportName .')';    $activeSubs[$key] = $value;}$cancelOK = false; // whether the record was successfully canceledif ($_POST['isSubmit'] == 'yes') {    // gets the form field values    $fldSubId       = intval($_POST['fldSubId']);    $fldReason      = mysql_real_escape_string($_POST['fldReason']);    $fldOtherReason = mysql_real_escape_string($_POST['other']);        // tbl_college_subscription data    $new_fldActive = 0;    $new_fldCancelDate        = date('Y-m-d');    $new_fldCancelReason  = $fldReason;    $new_fldCancelReasonOther = $fldOtherReason;        // tbl_college_coach data    $new_fldSubscribe   = ($subsCount > 1) ? 1 : 0;    $new_fldCancelCount = $fldCancelCount + 1;        // updates the record in tbl_college_subscription    $data = array('fldActive' => $new_fldActive,                  'fldCancelDate' => $new_fldCancelDate,                  'fldCancelReason' => $new_fldCancelReason,                  'fldCancelReasonOther' => $new_fldCancelReasonOther);    $rows = $db->updateRec(TBL_COLLEGE_SUBSCRIPTION,                            $data, 'fldId=' . $fldSubId);        // updates the record in tbl_college_coach_register    $data = array('fldSubscribe' => $new_fldSubscribe,                  'fldCancelCount' => $new_fldCancelCount);    $rows = $db->updateRec(TBL_COLLEGE_COACH_REGISTER,                           $data, 'fldId=' . $fldCoach);        $cancelOK = true;}?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml">    <head>        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />        <title>College Prospect Network</title>        <link href="css/style.css" rel="stylesheet" type="text/css" />                <script type="text/javascript">            function validate(form)            {                // asks the user to confirm the cancellation                var msg = "Are you sure you want to cancel this subscription?";                                if (!confirm(msg)) {                    return false;                }                                // initiates an array of validation errors                var errors = new Array();                                // gets the fields that need to be validated                var fldSubId  = form['fldSubId'].value;                var fldReason = form['fldReason'].value;                var fldOther  = form['other'].value;                                if (fldSubId == 'select') {                    errors.push('Please select an active subscription');                }                                if (fldReason == 'select' && fldOther == '') {                    errors.push('Please select a reason from the ' +                                'list or enter your own reason');                }                                if (errors.length > 0) {                    var p = document.getElementById('error');                                        p.innerHTML = 'Please correct the following errors and try again:<ul>';                                        for (i in errors) {                        p.innerHTML += '<li>' + errors[i] + '</li>';                    }                                        p.innerHTML += '</ul>';                                        window.scrollTo(0, 0);                                        return false;                }                                return true;            }        </script>    </head>    <body>        <!--header link starts from here -->        <?php include ('header.php'); ?>        <!--Header ends from here -->        <!--middle panel starts from here -->        <!--content panel starts from here -->        <div class="container">            <div class="innerWraper">                <div class="middle-bg">                    <div class="cantener">                        <div class="register-main">                            <div class="registerPage">                                <form name="frmAthReg" action="" method="post" enctype="multipart/form-data" onsubmit="return validate(this);">                                    <h1>Cancel College Subscription</h1>                                                        <?php if ($subsCount > 0): ?>                                    <p id="error" style="color: #ff0000;"></p>                                    <p>                                        Please select the subscription you                                         would like to cancel below and provide                                         a reason for canceling it. Please note                                         that if you click "Continue" you will                                         not be able to register again for                                         30 days.                                    </p>                                    <p>                                        <label>Subscription:</label>                                        <span>                                            <select name="fldSubId">                                                <option value="select">                                                    Please Select Subscription                                                </option>                                                                                                <?php foreach ($activeSubs as $id => $name): ?>                                                <option value="<?php echo $id ?>">                                                    <?php echo $name; ?>                                                </option>                                                <?php endforeach; ?>                                                                                            </select>                                        </span>                                    </p>                                    <p style="font-weight: bold;">                                        <br />                                        Please let us know why you are                                         canceling your subscription                                        <br /><br />                                    </p>                                    <p>                                        <label>Reason:</label>                                        <span>                                            <select name="fldReason">                                                <option value="select">Please Select Reason</option>                                                <option value="Cost">Cost</option>                                                <option value="Quality of athlete">Quantity of athletes</option>                                                <option value="No longer employed by college">No longer employed by college</option>                                            </select>                                        </span>                                    </p>                                    <p>                                        <label>For Other Reason:</label>                                        <span>                                            <input type="text" name="other" />                                        </span>                                    </p>                                    <p>                                        <label>&nbsp;</label>                                        <span>                                            <input type="hidden" name="isSubmit" value="yes" />                                            <input type="submit" name="submit" value="Continue" />                                            <input type="button" value="Back" onclick="history.go(-1);" />                                        </span>                                    </p>                                                                        <?php else: ?>                                                                        <div class="thankyoumessage">You have no active subscriptions</div>                                    <p>                                        <label>&nbsp;</label>                                        <span>                                                                                <INPUT TYPE="BUTTON" VALUE="Back" ONCLICK="history.go(-1)">                                        </span>                                    </p>                                                                        <?php endif; ?>                                </form>                            </div>                        </div>                    </div>                </div>            </div>        </div>        <?php include ('footer.php'); ?>                <?php if ($cancelOK): ?>        <script type="text/javascript">            alert('Your subscription has been canceled');            document.location.href="CancelSubscription.php";        </script>        <?php endif; ?>     </body></html>